# PolicyOCR

## Description

PolicyOCR is a Ruby application that parses policy numbers from ASCII digital format text files. The system processes OCR-scanned policy documents where each policy number is represented using ASCII art-style digit patterns, validates checksums, and outputs formatted results with appropriate error messages for invalid digits and checksum failures.

## Getting Started

### Prerequisites

- Ruby 3.0+ ([installation guide](https://www.ruby-lang.org/en/documentation/installation/))
- Bundler (`gem install bundler`)

### Installation

1. **Clone the repository** (if you haven't already):
   ```bash
   git clone <repository-url>
   cd policy-number-challenge
   ```

2. **Install dependencies**:
   ```bash
   bundle install
   ```

3. **Verify installation**:
   ```bash
   ./policy_ocr --help
   # OR using bundle exec:
   bundle exec ./policy_ocr --help
   ```

   You should see the Thor help output showing available commands.

4. **Make executable** (optional):
   ```bash
   chmod +x policy_ocr
   ```

**Note**: Use `bundle exec ./policy_ocr` if you encounter permission issues.

## Usage

### Commands

The command line interface has two commands: `parse` and `generate_policy_numbers`

#### Parse:

The `parse` command takes a filename and attempts to parse the policy numbers.

Syntax

```bash
./policy_ocr parse <input_file>
```

Example

```bash
# Parse a sample file
./policy_ocr parse spec/fixtures/sample.txt

# View results
ls parsed_files/
cat parsed_files/sample_parsed.txt
```

#### Generate Policy Numbers (test data):

The `generate_policy_numbers` command creates ASCII test data containing randomized 9-digit policy numbers in the 3-line format expected by the OCR parser. This includes a mix of valid numbers, numbers with checksum errors, numbers with invalid digit patterns, and unparseable patterns for comprehensive testing.

Syntax

```bash
./policy_ocr generate_policy_numbers [options] > <output_file>
```

Options:
- `--valid-count=N` - Number of valid policy numbers to generate (default: 20)
- `--invalid-digits-count=N` - Number of policy numbers with invalid digits (default: 6)
- `--invalid-checksum-count=N` - Number of policy numbers with checksum errors (default: 4)
- `--unparseable-count=N` - Number of unparseable patterns to generate (default: 0)

Example

```bash
# Generate with default distribution
./policy_ocr generate_policy_numbers > test_data.txt

# Generate custom distribution
./policy_ocr generate_policy_numbers --valid-count=10 --invalid-digits-count=5 --invalid-checksum-count=3 --unparseable-count=2 > test_data.txt

# Parse the generated file
./policy_ocr parse test_data.txt
```

#### Output Files

Parsed results are written to the `/parsed_files` directory as plain text files named `<filename>_parsed.txt`. Each line contains either a valid 9-digit policy number followed by a space, or the number followed by ` ERR` (checksum error) or ` ILL` (invalid/unparseable digits).

```
000000000 
123456789 ERR
86110??36 ILL
```

#### Logs

Logs are generated by the parse action per-file, and are found in the `/log` directory. 
They are named following the pattern `<filename>_parsed.log`

```bash
# Parse a sample file
./policy_ocr parse spec/fixtures/sample.txt

# View logs
ls log/
cat log/sample_parsed.log
```

### Example Output

**Parsing a file with mixed results** (`spec/fixtures/mixed_policy_numbers.txt`):

```
âœ  policy-number-challenge git:(master) ./policy_ocr parse spec/fixtures/mixed_policy_numbers.txt

============================================================
âœ… SUCCESSFULLY PARSED mixed_policy_numbers.txt
============================================================

ğŸ“„ Input File: spec/fixtures/mixed_policy_numbers.txt
ğŸ“ Output File: parsed_files/mixed_policy_numbers_parsed.txt
ğŸ“‹ Log File: log/mixed_policy_numbers_parsed.log

ğŸ“ˆ PARSING STATISTICS:
  Total Lines Parsed: 30
  âœ… Valid Numbers: 20
  âŒ Invalid Checksum (ERR): 4
  â“ Invalid Digits (ILL): 6
  ğŸš« Unparseable: 0

âœ¨ Parsing completed successfully!
============================================================
```

**Parsing a file with parsing errors** (`spec/fixtures/malformed_content.txt`):

```
âœ  policy-number-challenge git:(master) ./policy_ocr parse spec/fixtures/malformed_content.txt

============================================================
âš ï¸  PARSED malformed_content.txt WITH ERRORS
============================================================

ğŸ“„ Input File: spec/fixtures/malformed_content.txt
ğŸ“ Output File: parsed_files/malformed_content_parsed.txt
ğŸ“‹ Log File: log/malformed_content_parsed.log

ğŸ“ˆ PARSING STATISTICS:
  Total Lines Parsed: 4
  âœ… Valid Numbers: 1
  âŒ Invalid Checksum (ERR): 2
  â“ Invalid Digits (ILL): 0
  ğŸš« Unparseable: 1

âš ï¸  PARSER ERRORS ENCOUNTERED:
  1. Line 4: Lines must be divisible by 3 characters for proper digit parsing
  This is not valid OCR content
  Just some random text
  That should not parse correctly

âœ¨ Parsing completed successfully!
============================================================
```

### Sample Files

Test with included sample files:

- `spec/fixtures/sample.txt` - Basic valid policy numbers
- `spec/fixtures/mixed_policy_numbers.txt` - Mix of valid, ERR, and ILL numbers  
- `spec/fixtures/checksum_errors.txt` - Checksum validation failures
- `spec/fixtures/invalid_digits.txt` - Unrecognizable digit patterns
- `spec/fixtures/malformed_content.txt` - Malformed input for error testing

### Running Tests

```bash
bundle exec rspec
```

## Architecture

### Interactor Pattern

This application uses the [Interactor gem from CollectiveIdea](https://github.com/collectiveidea/interactor). This pattern uses a variation on the Command or Strategy pattern to express the basic business rules of the application. 

### Core Components

#### Policy Classes (`lib/policy_ocr/policy/`)
- **Document**: Represents a collection of policy numbers from a document
- **Number**: Represents a single policy number with validation and formatting
- **Number::Unparseable**: Subclass for handling unparseable policy numbers

#### Parser Classes (`lib/policy_ocr/parser/`)
- **ParsePolicyDocumentFile**: Reads and processes policy document files
- **ParsePolicyDocumentText**: Parses raw text into policy numbers
- **ParsePolicyNumberLine**: Converts ASCII digit patterns into policy numbers

#### DigitalInt classes (`lib/policy_ocr/digital_int/`)
- **DigitalInt::Base**: Base class for digital representations
- **DigitalInt**: Factory for creating digit instances from patterns
- **DigitalInt::Zero through Nine**: Individual classes for each digit (0-9) with readable ASCII art patterns
- **DigitalInt::Invalid**: Handles unrecognizable digit patterns

#### Validation
- **ValidatePolicyNumberChecksum**: Implements weighted checksum validation using the formula: `(d1Ã—1 + d2Ã—2 + ... + d9Ã—9) mod 11 = 0`

#### CLI Interface (`lib/policy_ocr/cli/`)
- **PolicyOcr::Cli**: Thor-based command-line interface for parsing and generating policy numbers
- **PrintReport**: Interactor for displaying parsing results and statistics
- **WriteOutputFile**: Interactor for writing parsed results to output files with proper directory structure
- **GenerateSamplePolicyNumbers**: Interactor for generating test policy numbers with configurable distributions


### Class Organization

The final output structure of a parsed document has the following class organization:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                      Parsed Document                                      â”‚
â”‚                                                                                           â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚    â”‚ Policy::Document â”‚         â”‚  Policy::Number  â”‚          â”‚    DigitalInt    â”‚        â”‚
â”‚    â”‚                  â”‚ 1..*    â”‚                  â”‚ 1..*     â”‚                  â”‚        â”‚
â”‚    â”‚ policy_numbers   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ digital_ints     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ int_value        â”‚        â”‚
â”‚    â”‚                  â”‚         â”‚                  â”‚          â”‚ pattern          â”‚        â”‚
â”‚    â”‚                  â”‚         â”‚                  â”‚          â”‚                  â”‚        â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                                           â”‚
â”‚                                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Parsing Workflow

This is the general sequence of parsing, starting with the ParsePolicyDocumentFile, which reads the file contents and passes the raw text to the ParsePolicyDocumentText interactor.
ParsePolicyNumberLine creates an array of numbers, and that array is used to create the final Policy::Document. 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         â”‚     â”‚                         â”‚     â”‚                       â”‚    â”‚                     â”‚
â”‚                         â”‚     â”‚                         â”‚     â”‚                       â”‚    â”‚                     â”‚
â”‚ ParsePolicyDocumentFile â”‚     â”‚ ParsePolicyDocumentText â”‚     â”‚ ParsePolicyNumberLine â”‚    â”‚   Policy::Number    â”‚
â”‚                         â”‚     â”‚                         â”‚     â”‚                       â”‚    â”‚                     â”‚
â”‚                         â”‚     â”‚                         â”‚     â”‚                       â”‚    â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                               â”‚                              â”‚                           â”‚           
             â”‚                               â”‚                              â”‚                           â”‚           
             â”‚           raw_text            â”‚                              â”‚                           â”‚           
             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                              â”‚                           â”‚           
             â”‚                               â”‚        number_line           â”‚                           â”‚           
             â”‚                               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                           â”‚           
             â”‚                               â”‚                              â”‚         create            â”‚           
             â”‚                               â”‚                              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚           
             â”‚                               â”‚                              â”‚                           â”‚           
             â”‚                               â”‚                              â”‚                           â”‚           
             â”‚                               â”‚                              â”‚                           â”‚           
             â”‚                               â”‚                              â”‚      Policy::Number       â”‚           
             â”‚                               â”‚                              â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚           
             â”‚                               â”‚       Policy::Number         â”‚                           â”‚           
             â”‚                               â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                           â”‚           
             â”‚        Policy::Document       â”‚                              â”‚                           â”‚           
             â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                              â”‚                           â”‚           
             â”‚                               â”‚                              â”‚                           â”‚           
             â”‚                               â”‚                              â”‚                           â”‚           
             â”‚                               â”‚                              â”‚                           â”‚           

```

### CLI Interface Workflow

The command-line interface orchestrates the parsing workflow through interactors:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 â”‚    â”‚                         â”‚     â”‚                 â”‚       â”‚                 â”‚
â”‚       CLI       â”‚    â”‚ ParsePolicyDocumentFile â”‚     â”‚ WriteOutputFile â”‚       â”‚   PrintReport   â”‚
â”‚                 â”‚    â”‚                         â”‚     â”‚                 â”‚       â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                          â”‚                           â”‚                         â”‚         
         â”‚                          â”‚                           â”‚                         â”‚         
         â”‚           call           â”‚                           â”‚                         â”‚         
         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                           â”‚                         â”‚         
         â”‚                          â”‚                           â”‚                         â”‚         
         â”‚           result         â”‚                           â”‚                         â”‚         
         â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚                         â”‚         
         â”‚                          â”‚                           â”‚                         â”‚         
         â”‚                          â”‚                           â”‚                         â”‚         
         â”‚                          â”‚    call                   â”‚                         â”‚         
         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                         â”‚         
         â”‚                          â”‚                           â”‚                         â”‚         
         â”‚                          â”‚   result                  â”‚                         â”‚         
         â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                         â”‚         
         â”‚                          â”‚                           â”‚                         â”‚         
         â”‚                          â”‚                           â”‚                         â”‚         
         â”‚                          â”‚            call           â”‚                         â”‚         
         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚         
         â”‚                          â”‚                           â”‚                         â”‚         
         â”‚                          â”‚                           â”‚                         â”‚         
         â”‚                          â”‚                           â”‚                         â”‚         
```
